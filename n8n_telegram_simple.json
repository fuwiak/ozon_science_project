{
  "name": "Telegram API Commands - Simple",
  "nodes": [
    {
      "parameters": {
        "updates": ["message", "callback_query"],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [250, 300],
      "credentials": {
        "telegramApi": {
          "id": "I8mNTuvUFq3COzyU",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Jeden wƒôze≈Ç kt√≥ry robi wszystko: rozpoznaje komendƒô, wywo≈Çuje API, formatuje odpowied≈∫\nconst text = ($input.item.json.message?.text || '').trim();\nconst chatId = $input.item.json.message?.chat?.id;\nconst baseUrl = 'https://ozonscienceproject-production.up.railway.app';\n\n// Mapowanie komend\nconst commands = {\n  '/stats': { url: '/api/cache/stats', type: 'stats' },\n  '/cache': { url: '/api/cache/stats', type: 'stats' },\n  '/dashboard': { url: '/api/analytics/pricing-metrics?min_days_out_of_stock=15', type: 'dashboard' },\n  '/metrics': { url: '/api/analytics/pricing-metrics?min_days_out_of_stock=15', type: 'dashboard' },\n  '/products': { url: '/api/products?page=1&page_size=5', type: 'products' },\n  '/top': { url: '/api/analytics/demand/top?limit=10', type: 'top' },\n  '/outofstock': { url: '/api/analytics/stock/out-of-stock?min_days=30', type: 'outofstock' },\n  '/cache_clear': { url: '/api/cache/clear', type: 'cache_action', method: 'POST' },\n  '/cache_reload': { url: '/api/cache/reload', type: 'cache_action', method: 'POST' },\n  '/help': { url: null, type: 'help' }\n};\n\n// Sprawd≈∫ czy to komenda\nif (!text.startsWith('/')) {\n  return { json: { chatId, message: '‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å /' } };\n}\n\nconst command = text.split(' ')[0].toLowerCase();\nconst cmdData = commands[command];\n\nif (!cmdData) {\n  return { \n    json: { \n      chatId, \n      message: '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.'\n    } \n  };\n}\n\n// Help\nif (cmdData.type === 'help') {\n  const helpText = `ü§ñ <b>Dynamic Pricing 1299$</b>\\n\\n` +\n    `–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\\n\\n` +\n    `üìä <b>–î–∞—à–±–æ—Ä–¥</b>\\n` +\n    `/dashboard - –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\\n\\n` +\n    `üì¶ <b>–¢–æ–≤–∞—Ä—ã</b>\\n` +\n    `/products - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤\\n` +\n    `/top - –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤\\n\\n` +\n    `üìà <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>\\n` +\n    `/outofstock - –¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞\\n` +\n    `/metrics - –ú–µ—Ç—Ä–∏–∫–∏ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è\\n\\n` +\n    `üóÑÔ∏è <b>–ö—ç—à</b>\\n` +\n    `/cache - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞\\n` +\n    `/cache_clear - –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à\\n` +\n    `/cache_reload - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à\\n\\n` +\n    `‚ùì <b>–ü–æ–º–æ—â—å</b>\\n` +\n    `/help - –≠—Ç–æ—Ç —Å–ø–∏—Å–æ–∫`;\n  \n  return { json: { chatId, message: helpText } };\n}\n\n// Wywo≈Çaj API\nlet apiResponse;\ntry {\n  const method = cmdData.method || 'GET';\n  const url = baseUrl + cmdData.url;\n  \n  if (method === 'POST') {\n    apiResponse = await $http.request({\n      method: 'POST',\n      url: url,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  } else {\n    apiResponse = await $http.request({\n      method: 'GET',\n      url: url\n    });\n  }\n} catch (error) {\n  return { \n    json: { \n      chatId, \n      message: `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ API: ${error.message}`\n    } \n  };\n}\n\n// Formatuj odpowied≈∫\nlet message = '';\n\nswitch(cmdData.type) {\n  case 'stats':\n    message = `üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞</b>\\n\\n` +\n      `–¢–æ–≤–∞—Ä–æ–≤: ${apiResponse.total_products?.toLocaleString() || 0}\\n` +\n      `–§–∞–π–ª–æ–≤: ${apiResponse.files_loaded || 0}\\n` +\n      `–†–∞–∑–º–µ—Ä: ${apiResponse.cache_size_mb?.toFixed(2) || 0} –ú–ë\\n` +\n      `–†–µ–∂–∏–º: ${apiResponse.using_mock_data ? '–ú–æ–∫ –¥–∞–Ω–Ω—ã–µ' : '–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`;\n    break;\n    \n  case 'dashboard':\n    const metrics = apiResponse.metrics || [];\n    const highPriority = metrics.filter(m => m.priority_score >= 70).length;\n    const criticalStock = metrics.filter(m => m.days_out_of_stock > 30).length;\n    const highDemand = metrics.filter(m => m.demand_level === 'high').length;\n    \n    message = `üìä <b>–î–∞—à–±–æ—Ä–¥</b>\\n\\n` +\n      `üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${highPriority}\\n` +\n      `üì¶ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏: ${criticalStock}\\n` +\n      `üìà –í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å: ${highDemand}\\n` +\n      `üìä –í—Å–µ–≥–æ –º–µ—Ç—Ä–∏–∫: ${metrics.length}`;\n    break;\n    \n  case 'products':\n    const products = apiResponse.products || [];\n    message = `üì¶ <b>–¢–æ–≤–∞—Ä—ã</b> (${apiResponse.total || 0} –≤—Å–µ–≥–æ)\\n\\n`;\n    products.slice(0, 5).forEach((p, i) => {\n      message += `${i + 1}. ${p.name || p.product_name}\\n` +\n        `   ‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: ${p.favorites_count?.toLocaleString() || 0}\\n` +\n        `   üì¶ –î–Ω–µ–π –Ω–µ—Ç: ${p.days_out_of_stock || '-'}\\n\\n`;\n    });\n    if (apiResponse.total > 5) {\n      message += `... –∏ –µ—â–µ ${apiResponse.total - 5} —Ç–æ–≤–∞—Ä–æ–≤`;\n    }\n    break;\n    \n  case 'top':\n    const topProducts = Array.isArray(apiResponse) ? apiResponse : [];\n    message = `üèÜ <b>–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤</b>\\n\\n`;\n    topProducts.slice(0, 5).forEach((p, i) => {\n      message += `${i + 1}. ${p.product_name || p.name}\\n` +\n        `   ‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: ${p.favorites_count?.toLocaleString() || 0}\\n` +\n        `   üèÖ –†–∞–Ω–≥: ${p.rank || i + 1}\\n\\n`;\n    });\n    break;\n    \n  case 'outofstock':\n    const outOfStock = Array.isArray(apiResponse) ? apiResponse : [];\n    message = `‚ö†Ô∏è <b>–¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞</b> (${outOfStock.length})\\n\\n`;\n    outOfStock.slice(0, 5).forEach((p, i) => {\n      message += `${i + 1}. ${p.product_name || p.name}\\n` +\n        `   üì¶ –î–Ω–µ–π –Ω–µ—Ç: ${p.days_out_of_stock || 0}\\n` +\n        `   ‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${p.priority_score || 0}\\n\\n`;\n    });\n    if (outOfStock.length > 5) {\n      message += `... –∏ –µ—â–µ ${outOfStock.length - 5} —Ç–æ–≤–∞—Ä–æ–≤`;\n    }\n    break;\n    \n  case 'cache_action':\n    message = apiResponse.message || `‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞: ${command}`;\n    break;\n    \n  default:\n    message = JSON.stringify(apiResponse, null, 2);\n}\n\nreturn { json: { chatId, message } };"
      },
      "id": "handle-command",
      "name": "Handle Command",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "send-telegram",
      "name": "Send Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": {
        "telegramApi": {
          "id": "I8mNTuvUFq3COzyU",
          "name": "Telegram account"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Handle Command",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Command": {
      "main": [
        [
          {
            "node": "Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}

