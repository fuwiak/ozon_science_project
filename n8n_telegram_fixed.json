{
      "name": "Telegram API - Dynamic Pricing",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ URL –∏ –º–µ—Ç–æ–¥–∞ –¥–ª—è HTTP Request\n// Lazy evaluation: –∫–æ–º–∞–Ω–¥—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\nconst text = ($input.item.json.message?.text || '').trim();\nconst chatId = $input.item.json.message?.chat?.id;\nconst baseUrl = 'https://ozonscienceproject-production.up.railway.app';\n\n// –ú–∞–ø–ø–∏–Ω–≥ –∫–æ–º–∞–Ω–¥ –Ω–∞ endpoint'—ã (lazy loading)\nconst commands = {\n  '/stats': { url: '/api/cache/stats', type: 'stats' },\n  '/cache': { url: '/api/cache/stats', type: 'stats' },\n  '/dashboard': { url: '/api/analytics/pricing-metrics?min_days_out_of_stock=15&limit=5', type: 'dashboard' },\n  '/metrics': { url: '/api/analytics/pricing-metrics?min_days_out_of_stock=15&limit=5', type: 'dashboard' },\n  '/products': { url: '/api/products?page=1&page_size=3', type: 'products' },\n  '/top': { url: '/api/analytics/demand/top?limit=5', type: 'top' },\n  '/outofstock': { url: '/api/analytics/stock/out-of-stock?min_days=30&limit=5', type: 'outofstock' },\n  '/cache_clear': { url: '/api/cache/clear', type: 'cache_action', method: 'POST' },\n  '/cache_reload': { url: '/api/cache/reload', type: 'cache_action', method: 'POST' },\n  '/help': { url: null, type: 'help' }\n};\n\n// –ü—Ä–æ–≤–µ—Ä–∫–∞: —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥–æ–π\nif (!text.startsWith('/')) {\n  return [{ json: { chatId, message: '‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å /', skipApi: true } }];\n}\n\n// Lazy evaluation: –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\nconst command = text.split(' ')[0].toLowerCase();\nconst cmdData = commands[command];\n\nif (!cmdData) {\n  return [{ json: { chatId, message: '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help', skipApi: true } }];\n}\n\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã help (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç API)\nif (cmdData.type === 'help') {\n  return [{ json: { \n    chatId, \n    message: `ü§ñ <b>Dynamic Pricing 1299$</b>\\n\\n` +\n      `üìä <b>–î–∞—à–±–æ—Ä–¥</b>\\n` +\n      `/dashboard - –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏\\n` +\n      `/metrics - –ú–µ—Ç—Ä–∏–∫–∏ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è\\n\\n` +\n      `üì¶ <b>–¢–æ–≤–∞—Ä—ã</b>\\n` +\n      `/products - –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤\\n` +\n      `/top - –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤\\n\\n` +\n      `üìà <b>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</b>\\n` +\n      `/outofstock - –¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞\\n\\n` +\n      `üóÑÔ∏è <b>–ö—ç—à</b>\\n` +\n      `/cache - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞\\n` +\n      `/cache_clear - –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à\\n` +\n      `/cache_reload - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫—ç—à\\n\\n` +\n      `‚ùì <b>–ü–æ–º–æ—â—å</b>\\n` +\n      `/help - –≠—Ç–æ—Ç —Å–ø–∏—Å–æ–∫\\n\\n` +\n      `‚è≥ <i>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã –º–æ–≥—É—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö</i>`,\n    skipApi: true\n  } }];\n}\n\n// –í–æ–∑–≤—Ä–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è HTTP Request (lazy evaluation)\nreturn [{ json: { \n  chatId, \n  url: baseUrl + cmdData.url, \n  method: cmdData.method || 'GET',\n  commandType: cmdData.type,\n  skipApi: false\n} }];"
      },
      "id": "prepare-request",
      "name": "Prepare Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.skipApi }}",
              "value2": false
            }
          ]
        }
      },
      "id": "check-skip",
      "name": "Skip API?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "method": "={{ $json.method }}",
        "url": "={{ $json.url }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": false,
              "neverError": false,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "http-request",
      "name": "Call API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        850,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –æ—Ç API\n// Lazy evaluation: –¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏\n// –í n8n, –∫–æ–≥–¥–∞ HTTP Request –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤, –æ–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ $input.all() –∏–ª–∏ $input.item.json\nconst input = $input.item.json;\nconst allItems = $input.all();\nconst prepareData = $('Prepare Request').item.json;\nconst commandType = prepareData.commandType;\nconst chatId = prepareData.chatId;\n\n// –ï—Å–ª–∏ skipApi, –≤–µ—Ä–Ω—É—Ç—å –≥–æ—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (lazy evaluation)\nif (prepareData.skipApi || input.message) {\n  return [{ json: { chatId, message: input.message || input.text } }];\n}\n\n// Lazy evaluation: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –¥–∞–Ω–Ω—ã—Ö\nconst apiResponse = input;\nlet message = '';\n\nswitch(commandType) {\n  case 'stats':\n    // Lazy evaluation: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º\n    const totalProducts = apiResponse.total_products || 0;\n    const filesLoaded = apiResponse.files_loaded || 0;\n    const cacheSize = apiResponse.cache_size_mb || 0;\n    const isMockData = apiResponse.using_mock_data || false;\n    \n    message = `üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—ç—à–∞</b>\\n\\n` +\n      `–¢–æ–≤–∞—Ä–æ–≤: ${totalProducts.toLocaleString()}\\n` +\n      `–§–∞–π–ª–æ–≤: ${filesLoaded}\\n` +\n      `–†–∞–∑–º–µ—Ä: ${cacheSize.toFixed(2)} –ú–ë\\n` +\n      `–†–µ–∂–∏–º: ${isMockData ? '–ú–æ–∫ –¥–∞–Ω–Ω—ã–µ' : '–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'}`;\n    break;\n    \n  case 'dashboard':\n    // Lazy evaluation: –∑–∞–≥—Ä—É–∑–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é\n    const metrics = (apiResponse.metrics || []).slice(0, 5);\n    const highPriority = metrics.filter(m => m.priority_score >= 70).length;\n    const criticalStock = metrics.filter(m => m.days_out_of_stock > 30).length;\n    const highDemand = metrics.filter(m => m.demand_level === 'high').length;\n    const totalMetrics = apiResponse.total_metrics || apiResponse.metrics?.length || 0;\n    \n    message = `üìä <b>–î–∞—à–±–æ—Ä–¥</b>\\n\\n` +\n      `üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${highPriority}\\n` +\n      `üì¶ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏: ${criticalStock}\\n` +\n      `üìà –í—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å: ${highDemand}\\n` +\n      `üìä –í—Å–µ–≥–æ –º–µ—Ç—Ä–∏–∫: ${totalMetrics}\\n` +\n      `–ü–æ–∫–∞–∑–∞–Ω–æ: ${metrics.length} –∏–∑ ${totalMetrics}`;\n    \n    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–µ\n    if (totalMetrics > 100) {\n      message += `\\n\\n‚è≥ <i>–û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è</i>`;\n    }\n    break;\n    \n  case 'products':\n    // Lazy evaluation: –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö 3 —Ç–æ–≤–∞—Ä–æ–≤\n    const products = (apiResponse.products || []).slice(0, 3);\n    const totalProductsCount = apiResponse.total || 0;\n    \n    message = `üì¶ <b>–¢–æ–≤–∞—Ä—ã</b> (${totalProductsCount} –≤—Å–µ–≥–æ)\\n\\n`;\n    \n    if (products.length === 0) {\n      message += `‚è≥ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...\\n` +\n        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.`;\n    } else {\n      products.forEach((p, i) => {\n        message += `${i + 1}. ${p.name || p.product_name}\\n` +\n          `   ‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: ${(p.favorites_count || 0).toLocaleString()}\\n`;\n      });\n      if (totalProductsCount > 3) {\n        message += `\\n... –∏ –µ—â–µ ${totalProductsCount - 3} —Ç–æ–≤–∞—Ä–æ–≤`;\n      }\n    }\n    break;\n    \n  case 'top':\n    // API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ - –≤ n8n –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ $input.all() –∏–ª–∏ $input.item.json\n    // Lazy evaluation: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é\n    let topProducts = [];\n    \n    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∞ (lazy loading)\n    if (allItems && allItems.length > 0 && allItems[0].json) {\n      // –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –º–∞—Å—Å–∏–≤–∞ —è–≤–ª—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º item'–æ–º\n      topProducts = allItems.map(item => item.json).filter(p => p.product_name || p.name);\n    } else if (Array.isArray(apiResponse)) {\n      // –ú–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é –≤ apiResponse\n      topProducts = apiResponse;\n    } else if (apiResponse && typeof apiResponse === 'object') {\n      // –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ–±–µ—Ä–Ω—É—Ç–æ –≤ –æ–±—ä–µ–∫—Ç\n      if (Array.isArray(apiResponse.body)) {\n        topProducts = apiResponse.body;\n      } else if (Array.isArray(apiResponse.data)) {\n        topProducts = apiResponse.data;\n      } else if (Array.isArray(apiResponse.products)) {\n        topProducts = apiResponse.products;\n      } else if (apiResponse.json && Array.isArray(apiResponse.json)) {\n        topProducts = apiResponse.json;\n      }\n    }\n    \n    message = `üèÜ <b>–¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤</b>\\n\\n`;\n    if (topProducts.length === 0) {\n      message += `‚è≥ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...\\n` +\n        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.`;\n    } else {\n      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ rank –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω (lazy evaluation)\n      topProducts.sort((a, b) => (a.rank || 0) - (b.rank || 0));\n      topProducts.slice(0, 5).forEach((p) => {\n        const name = p.product_name || p.name || '–¢–æ–≤–∞—Ä';\n        const favorites = p.favorites_count || p.favorites || 0;\n        const rank = p.rank || '?';\n        message += `${rank}. ${name}\\n` +\n          `   ‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ: ${favorites.toLocaleString()}\\n\\n`;\n      });\n      if (topProducts.length > 5) {\n        message += `... –∏ –µ—â–µ ${topProducts.length - 5} —Ç–æ–≤–∞—Ä–æ–≤`;\n      }\n    }\n    break;\n    \n  case 'outofstock':\n    // Lazy evaluation: –∑–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã—Ö 5 —Ç–æ–≤–∞—Ä–æ–≤ –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞\n    const outOfStock = Array.isArray(apiResponse) ? apiResponse.slice(0, 5) : [];\n    const totalOutOfStock = Array.isArray(apiResponse) ? apiResponse.length : 0;\n    \n    message = `‚ö†Ô∏è <b>–¢–æ–≤–∞—Ä—ã –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞</b> (${totalOutOfStock} –≤—Å–µ–≥–æ)\\n\\n`;\n    \n    if (outOfStock.length === 0) {\n      message += `‚è≥ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...\\n` +\n        `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.`;\n    } else {\n      outOfStock.forEach((p, i) => {\n        message += `${i + 1}. ${p.product_name || p.name}\\n` +\n          `   üì¶ –î–Ω–µ–π –Ω–µ—Ç: ${p.days_out_of_stock || 0}\\n`;\n      });\n      if (totalOutOfStock > 5) {\n        message += `\\n... –∏ –µ—â–µ ${totalOutOfStock - 5} —Ç–æ–≤–∞—Ä–æ–≤`;\n      }\n    }\n    break;\n    \n  case 'cache_action':\n    message = apiResponse.message || `‚úÖ –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞`;\n    break;\n    \n  default:\n    message = `‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–æ–º–∞–Ω–¥—ã\\n\\n` +\n      `–ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:\\n` +\n      JSON.stringify(apiResponse, null, 2).substring(0, 500);\n}\n\nreturn [{ json: { chatId, message } }];"
      },
      "id": "format-response",
      "name": "Format Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1050,
        200
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "send-telegram",
      "name": "Send Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        1250,
        200
      ]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Prepare Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Request": {
      "main": [
        [
          {
            "node": "Skip API?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Skip API?": {
      "main": [
        [
          {
            "node": "Call API",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call API": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Response": {
      "main": [
        [
          {
            "node": "Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}