{
  "workflows": [
    {
      "name": "Telegram API Commands Handler",
      "description": "ObsÅ‚uguje komendy Telegram i wywoÅ‚uje endpointy API",
      "nodes": [
        {
          "parameters": {
            "updates": ["message"],
            "additionalFields": {}
          },
          "id": "telegram-trigger",
          "name": "Telegram Trigger",
          "type": "n8n-nodes-base.telegramTrigger",
          "typeVersion": 1.2,
          "position": [250, 300]
        },
        {
          "parameters": {
            "conditions": {
              "string": [
                {
                  "value1": "={{ $json.message.text }}",
                  "operation": "startsWith",
                  "value2": "/"
                }
              ]
            }
          },
          "id": "check-command",
          "name": "Is Command?",
          "type": "n8n-nodes-base.if",
          "typeVersion": 1,
          "position": [450, 300]
        },
        {
          "parameters": {
            "jsCode": "// Rozpoznaj komendÄ™\nconst text = $input.item.json.message.text.toLowerCase().trim();\nconst commands = {\n  '/stats': '/api/cache/stats',\n  '/dashboard': '/api/analytics/pricing-metrics?min_days_out_of_stock=15',\n  '/products': '/api/products?page=1&page_size=5',\n  '/top': '/api/analytics/demand/top?limit=10',\n  '/outofstock': '/api/analytics/stock/out-of-stock?min_days=30',\n  '/metrics': '/api/analytics/pricing-metrics?min_days_out_of_stock=15',\n  '/cache': '/api/cache/stats',\n  '/cache_clear': { method: 'POST', url: '/api/cache/clear' },\n  '/cache_reload': { method: 'POST', url: '/api/cache/reload' },\n  '/help': 'help'\n};\n\nlet command = text.split(' ')[0];\nlet endpoint = commands[command];\n\nif (!endpoint) {\n  return { json: { error: 'Unknown command', command: text } };\n}\n\nif (endpoint === 'help') {\n  return {\n    json: {\n      command: 'help',\n      helpText: `ðŸ¤– Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:\\n\\n/stats - Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÑÑˆÐ°\\n/dashboard - Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´\\n/products - Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²\\n/top - Ð¢Ð¾Ð¿ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²\\n/outofstock - Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ°\\n/metrics - ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ†ÐµÐ½Ð¾Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ\\n/cache - Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÐºÑÑˆÐµÐ¼\\n/cache_clear - ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÑÑˆ\\n/cache_reload - ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÐºÑÑˆ\\n/help - ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ`\n    }\n  };\n}\n\nreturn {\n  json: {\n    command: command,\n    endpoint: endpoint,\n    method: endpoint.method || 'GET',\n    url: endpoint.url || endpoint,\n    chatId: $input.item.json.message.chat.id,\n    userId: $input.item.json.message.from.id\n  }\n};"
          },
          "id": "parse-command",
          "name": "Parse Command",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [650, 300]
        },
        {
          "parameters": {
            "conditions": {
              "string": [
                {
                  "value1": "={{ $json.command }}",
                  "operation": "equal",
                  "value2": "help"
                }
              ]
            }
          },
          "id": "is-help",
          "name": "Is Help?",
          "type": "n8n-nodes-base.if",
          "typeVersion": 1,
          "position": [850, 300]
        },
        {
          "parameters": {
            "method": "={{ $json.method }}",
            "url": "=https://ozonscienceproject-production.up.railway.app{{ $json.url }}",
            "options": {}
          },
          "id": "http-request",
          "name": "Call API",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [1050, 200]
        },
        {
          "parameters": {
            "jsCode": "// Formatuj odpowiedÅº z API\nconst data = $input.item.json;\nconst command = $('Parse Command').item.json.command;\n\nlet message = '';\n\nif (command === '/stats' || command === '/cache') {\n  const stats = data;\n  message = `ðŸ“Š Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÑÑˆÐ°:\\n\\n` +\n    `Ð¢Ð¾Ð²Ð°Ñ€Ð¾Ð²: ${stats.total_products?.toLocaleString() || 0}\\n` +\n    `Ð¤Ð°Ð¹Ð»Ð¾Ð²: ${stats.files_loaded || 0}\\n` +\n    `Ð Ð°Ð·Ð¼ÐµÑ€: ${stats.cache_size_mb?.toFixed(2) || 0} ÐœÐ‘\\n` +\n    `Ð ÐµÐ¶Ð¸Ð¼: ${stats.using_mock_data ? 'ÐœÐ¾Ðº Ð´Ð°Ð½Ð½Ñ‹Ðµ' : 'Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ'}`;\n} else if (command === '/dashboard' || command === '/metrics') {\n  const metrics = data.metrics || [];\n  const highPriority = metrics.filter(m => m.priority_score >= 70).length;\n  const criticalStock = metrics.filter(m => m.days_out_of_stock > 30).length;\n  const highDemand = metrics.filter(m => m.demand_level === 'high').length;\n  \n  message = `ðŸ“Š Ð”Ð°ÑˆÐ±Ð¾Ñ€Ð´:\\n\\n` +\n    `ðŸ”´ Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: ${highPriority}\\n` +\n    `ðŸ“¦ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸: ${criticalStock}\\n` +\n    `ðŸ“ˆ Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹ ÑÐ¿Ñ€Ð¾Ñ: ${highDemand}\\n` +\n    `ðŸ“Š Ð’ÑÐµÐ³Ð¾ Ð¼ÐµÑ‚Ñ€Ð¸Ðº: ${metrics.length}`;\n} else if (command === '/products') {\n  const products = data.products || [];\n  message = `ðŸ“¦ Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ (${data.total || 0} Ð²ÑÐµÐ³Ð¾):\\n\\n`;\n  products.slice(0, 5).forEach((p, i) => {\n    message += `${i + 1}. ${p.name || p.product_name}\\n` +\n      `   Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ: ${p.favorites_count?.toLocaleString() || 0}\\n` +\n      `   Ð”Ð½ÐµÐ¹ Ð½ÐµÑ‚: ${p.days_out_of_stock || '-'}\\n\\n`;\n  });\n} else if (command === '/top') {\n  const products = Array.isArray(data) ? data : [];\n  message = `ðŸ† Ð¢Ð¾Ð¿ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²:\\n\\n`;\n  products.slice(0, 5).forEach((p, i) => {\n    message += `${i + 1}. ${p.product_name || p.name}\\n` +\n      `   Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ: ${p.favorites_count?.toLocaleString() || 0}\\n` +\n      `   Ð Ð°Ð½Ð³: ${p.rank || i + 1}\\n\\n`;\n  });\n} else if (command === '/outofstock') {\n  const products = Array.isArray(data) ? data : [];\n  message = `âš ï¸ Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ° (${products.length}):\\n\\n`;\n  products.slice(0, 5).forEach((p, i) => {\n    message += `${i + 1}. ${p.product_name || p.name}\\n` +\n      `   Ð”Ð½ÐµÐ¹ Ð½ÐµÑ‚: ${p.days_out_of_stock || 0}\\n` +\n      `   ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: ${p.priority_score || 0}\\n\\n`;\n  });\n} else if (command === '/cache_clear' || command === '/cache_reload') {\n  message = data.message || `âœ… ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð°: ${command}`;\n} else {\n  message = JSON.stringify(data, null, 2);\n}\n\nreturn {\n  json: {\n    message: message,\n    chatId: $('Parse Command').item.json.chatId\n  }\n};"
          },
          "id": "format-response",
          "name": "Format Response",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [1250, 200]
        },
        {
          "parameters": {
            "chatId": "={{ $json.chatId }}",
            "text": "={{ $json.message }}",
            "additionalFields": {}
          },
          "id": "send-telegram",
          "name": "Send Telegram",
          "type": "n8n-nodes-base.telegram",
          "typeVersion": 1,
          "position": [1450, 200]
        },
        {
          "parameters": {
            "chatId": "={{ $('Parse Command').item.json.chatId }}",
            "text": "={{ $('Parse Command').item.json.helpText }}",
            "additionalFields": {}
          },
          "id": "send-help",
          "name": "Send Help",
          "type": "n8n-nodes-base.telegram",
          "typeVersion": 1,
          "position": [1050, 400]
        },
        {
          "parameters": {
            "chatId": "={{ $json.message.chat.id }}",
            "text": "âŒ ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ¾Ð¼Ð°Ð½Ð´Ð°. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ /help Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´.",
            "additionalFields": {}
          },
          "id": "send-error",
          "name": "Send Error",
          "type": "n8n-nodes-base.telegram",
          "typeVersion": 1,
          "position": [650, 500]
        }
      ],
      "connections": {
        "Telegram Trigger": {
          "main": [[{ "node": "Is Command?", "type": "main", "index": 0 }]]
        },
        "Is Command?": {
          "main": [
            [{ "node": "Parse Command", "type": "main", "index": 0 }],
            [{ "node": "Send Error", "type": "main", "index": 0 }]
          ]
        },
        "Parse Command": {
          "main": [[{ "node": "Is Help?", "type": "main", "index": 0 }]]
        },
        "Is Help?": {
          "main": [
            [{ "node": "Call API", "type": "main", "index": 0 }],
            [{ "node": "Send Help", "type": "main", "index": 0 }]
          ]
        },
        "Call API": {
          "main": [[{ "node": "Format Response", "type": "main", "index": 0 }]]
        },
        "Format Response": {
          "main": [[{ "node": "Send Telegram", "type": "main", "index": 0 }]]
        }
      }
    },
    {
      "name": "Telegram AI Agent with API Tools",
      "description": "AI Agent ktÃ³ry moÅ¼e wywoÅ‚ywaÄ‡ endpointy API jako tools",
      "nodes": [
        {
          "parameters": {
            "updates": ["message"],
            "additionalFields": {}
          },
          "id": "telegram-trigger-ai",
          "name": "Telegram Trigger",
          "type": "n8n-nodes-base.telegramTrigger",
          "typeVersion": 1.2,
          "position": [250, 300]
        },
        {
          "parameters": {
            "promptType": "define",
            "text": "=Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ OZON Dynamic Pricing API. Ð¢Ñ‹ Ð¼Ð¾Ð¶ÐµÑˆÑŒ:\n- ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÐºÑÑˆÐ° (/stats)\n- ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ Ñ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ°Ð¼Ð¸ (/dashboard)\n- Ð˜ÑÐºÐ°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ (/products)\n- ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð¿ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² (/top)\n- ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ° (/outofstock)\n- ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ†ÐµÐ½Ð¾Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ (/metrics)\n- Ð£Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ ÐºÑÑˆÐµÐ¼ (/cache_clear, /cache_reload)\n\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ tools Ð´Ð»Ñ Ð²Ñ‹Ð·Ð¾Ð²Ð° API. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð½Ð° Ñ€ÑƒÑÑÐºÐ¾Ð¼ ÑÐ·Ñ‹ÐºÐµ, Ð±ÑƒÐ´ÑŒ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ð¼ Ð¸ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¼.",
            "hasOutputParser": true,
            "tools": {
              "values": [
                {
                  "name": "get_cache_stats",
                  "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÐºÑÑˆÐ°",
                  "type": "function",
                  "function": {
                    "name": "get_cache_stats",
                    "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÐºÑÑˆÐ°: ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð², Ñ„Ð°Ð¹Ð»Ð¾Ð², Ñ€Ð°Ð·Ð¼ÐµÑ€ ÐºÑÑˆÐ°",
                    "parameters": {
                      "type": "object",
                      "properties": {},
                      "required": []
                    }
                  }
                },
                {
                  "name": "get_dashboard_metrics",
                  "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°",
                  "type": "function",
                  "function": {
                    "name": "get_dashboard_metrics",
                    "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ñ†ÐµÐ½Ð¾Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ: Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚, ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ñ‹Ðµ Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ¸, Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹ ÑÐ¿Ñ€Ð¾Ñ",
                    "parameters": {
                      "type": "object",
                      "properties": {
                        "min_days_out_of_stock": {
                          "type": "number",
                          "description": "ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð½ÐµÐ¹ Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ° (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 15)"
                        }
                      }
                    }
                  }
                },
                {
                  "name": "get_top_products",
                  "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð¿ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¿Ð¾ ÑÐ¿Ñ€Ð¾ÑÑƒ",
                  "type": "function",
                  "function": {
                    "name": "get_top_products",
                    "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð¿ N Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð¿Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ñƒ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ",
                    "parameters": {
                      "type": "object",
                      "properties": {
                        "limit": {
                          "type": "number",
                          "description": "ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 10)"
                        },
                        "category": {
                          "type": "string",
                          "description": "Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)"
                        }
                      }
                    }
                  }
                },
                {
                  "name": "get_out_of_stock",
                  "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ°",
                  "type": "function",
                  "function": {
                    "name": "get_out_of_stock",
                    "description": "ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹, Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð² Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ð¸ Ð±Ð¾Ð»ÐµÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð´Ð½ÐµÐ¹",
                    "parameters": {
                      "type": "object",
                      "properties": {
                        "min_days": {
                          "type": "number",
                          "description": "ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð´Ð½ÐµÐ¹ Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ñ‚ÐºÐ° (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 15)"
                        }
                      }
                    }
                  }
                },
                {
                  "name": "search_products",
                  "description": "ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²",
                  "type": "function",
                  "function": {
                    "name": "search_products",
                    "description": "ÐŸÐ¾Ð¸ÑÐº Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ð¼Ð¸",
                    "parameters": {
                      "type": "object",
                      "properties": {
                        "category": {
                          "type": "string",
                          "description": "ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)"
                        },
                        "min_favorites": {
                          "type": "number",
                          "description": "ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)"
                        },
                        "page": {
                          "type": "number",
                          "description": "ÐÐ¾Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 1)"
                        },
                        "page_size": {
                          "type": "number",
                          "description": "Ð Ð°Ð·Ð¼ÐµÑ€ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ 10)"
                        }
                      }
                    }
                  }
                }
              ]
            },
            "options": {}
          },
          "id": "ai-agent",
          "name": "AI Agent",
          "type": "@n8n/n8n-nodes-langchain.agent",
          "typeVersion": 3,
          "position": [450, 300]
        },
        {
          "parameters": {
            "model": "openai/gpt-4.1",
            "options": {}
          },
          "id": "openrouter-model",
          "name": "OpenRouter Chat Model",
          "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
          "typeVersion": 1,
          "position": [450, 500],
          "credentials": {
            "openRouterApi": {
              "id": "JR90UJFLQP93rEKp",
              "name": "OpenRouter account"
            }
          }
        },
        {
          "parameters": {
            "sessionIdType": "customKey",
            "sessionKey": "={{ $json.message.from.id }}"
          },
          "id": "memory",
          "name": "Simple Memory",
          "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
          "typeVersion": 1.3,
          "position": [450, 700]
        },
        {
          "parameters": {},
          "id": "output-parser",
          "name": "Structured Output Parser",
          "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
          "typeVersion": 1.3,
          "position": [450, 900]
        },
        {
          "parameters": {
            "functionName": "get_cache_stats",
            "respondWith": "allInputData"
          },
          "id": "tool-cache-stats",
          "name": "Tool: Cache Stats",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [650, 200],
          "parameters": {
            "method": "GET",
            "url": "https://ozonscienceproject-production.up.railway.app/api/cache/stats"
          }
        },
        {
          "parameters": {
            "functionName": "get_dashboard_metrics",
            "respondWith": "allInputData"
          },
          "id": "tool-dashboard",
          "name": "Tool: Dashboard",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [650, 300],
          "parameters": {
            "method": "GET",
            "url": "=https://ozonscienceproject-production.up.railway.app/api/analytics/pricing-metrics?min_days_out_of_stock={{ $json.min_days_out_of_stock || 15 }}"
          }
        },
        {
          "parameters": {
            "functionName": "get_top_products",
            "respondWith": "allInputData"
          },
          "id": "tool-top-products",
          "name": "Tool: Top Products",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [650, 400],
          "parameters": {
            "method": "GET",
            "url": "=https://ozonscienceproject-production.up.railway.app/api/analytics/demand/top?limit={{ $json.limit || 10 }}{{ $json.category ? '&category=' + $json.category : '' }}"
          }
        },
        {
          "parameters": {
            "functionName": "get_out_of_stock",
            "respondWith": "allInputData"
          },
          "id": "tool-out-of-stock",
          "name": "Tool: Out of Stock",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [650, 500],
          "parameters": {
            "method": "GET",
            "url": "=https://ozonscienceproject-production.up.railway.app/api/analytics/stock/out-of-stock?min_days={{ $json.min_days || 15 }}"
          }
        },
        {
          "parameters": {
            "functionName": "search_products",
            "respondWith": "allInputData"
          },
          "id": "tool-search",
          "name": "Tool: Search Products",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [650, 600],
          "parameters": {
            "method": "GET",
            "url": "=https://ozonscienceproject-production.up.railway.app/api/products?page={{ $json.page || 1 }}&page_size={{ $json.page_size || 10 }}{{ $json.category ? '&category_level_1=' + $json.category : '' }}{{ $json.min_favorites ? '&min_favorites_count=' + $json.min_favorites : '' }}"
          }
        },
        {
          "parameters": {
            "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
            "text": "={{ $json.output }}",
            "additionalFields": {}
          },
          "id": "send-reply",
          "name": "Send Telegram Reply",
          "type": "n8n-nodes-base.telegram",
          "typeVersion": 1,
          "position": [850, 300]
        }
      ],
      "connections": {
        "Telegram Trigger": {
          "main": [[{ "node": "AI Agent", "type": "main", "index": 0 }]]
        },
        "AI Agent": {
          "main": [[{ "node": "Send Telegram Reply", "type": "main", "index": 0 }]],
          "ai_tool": [
            [{ "node": "Tool: Cache Stats", "type": "ai_tool", "index": 0 }],
            [{ "node": "Tool: Dashboard", "type": "ai_tool", "index": 0 }],
            [{ "node": "Tool: Top Products", "type": "ai_tool", "index": 0 }],
            [{ "node": "Tool: Out of Stock", "type": "ai_tool", "index": 0 }],
            [{ "node": "Tool: Search Products", "type": "ai_tool", "index": 0 }]
          ]
        },
        "OpenRouter Chat Model": {
          "ai_languageModel": [[{ "node": "AI Agent", "type": "ai_languageModel", "index": 0 }]]
        },
        "Simple Memory": {
          "ai_memory": [[{ "node": "AI Agent", "type": "ai_memory", "index": 0 }]]
        },
        "Structured Output Parser": {
          "ai_outputParser": [[{ "node": "AI Agent", "type": "ai_outputParser", "index": 0 }]]
        },
        "Tool: Cache Stats": {
          "main": [[{ "node": "AI Agent", "type": "ai_tool", "index": 0 }]]
        },
        "Tool: Dashboard": {
          "main": [[{ "node": "AI Agent", "type": "ai_tool", "index": 0 }]]
        },
        "Tool: Top Products": {
          "main": [[{ "node": "AI Agent", "type": "ai_tool", "index": 0 }]]
        },
        "Tool: Out of Stock": {
          "main": [[{ "node": "AI Agent", "type": "ai_tool", "index": 0 }]]
        },
        "Tool: Search Products": {
          "main": [[{ "node": "AI Agent", "type": "ai_tool", "index": 0 }]]
        }
      }
    },
    {
      "name": "Telegram Scheduled Notifications",
      "description": "Automatyczne powiadomienia o krytycznych stanach",
      "nodes": [
        {
          "parameters": {
            "rule": {
              "interval": [
                {
                  "field": "hours",
                  "hoursInterval": 1
                }
              ]
            }
          },
          "id": "schedule-trigger",
          "name": "Schedule Trigger",
          "type": "n8n-nodes-base.scheduleTrigger",
          "typeVersion": 1.1,
          "position": [250, 300]
        },
        {
          "parameters": {
            "method": "GET",
            "url": "https://ozonscienceproject-production.up.railway.app/api/analytics/stock/out-of-stock?min_days=30",
            "options": {}
          },
          "id": "get-critical",
          "name": "Get Critical Products",
          "type": "n8n-nodes-base.httpRequest",
          "typeVersion": 4.1,
          "position": [450, 300]
        },
        {
          "parameters": {
            "conditions": {
              "number": [
                {
                  "value1": "={{ $json.length }}",
                  "operation": "larger",
                  "value2": 0
                }
              ]
            }
          },
          "id": "has-critical",
          "name": "Has Critical?",
          "type": "n8n-nodes-base.if",
          "typeVersion": 1,
          "position": [650, 300]
        },
        {
          "parameters": {
            "jsCode": "// Formatuj wiadomoÅ›Ä‡ o krytycznych produktach\nconst products = $input.all();\nconst critical = products.filter(p => p.json.days_out_of_stock > 30 && p.json.priority_score >= 80);\n\nif (critical.length === 0) {\n  return { json: { skip: true } };\n}\n\nlet message = `âš ï¸ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• Ð¢ÐžÐ’ÐÐ Ð« Ð‘Ð•Ð— ÐžÐ¡Ð¢ÐÐ¢ÐšÐ\\n\\n`;\nmessage += `ÐÐ°Ð¹Ð´ÐµÐ½Ð¾: ${critical.length} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²\\n\\n`;\n\ncritical.slice(0, 10).forEach((p, i) => {\n  const prod = p.json;\n  message += `${i + 1}. ${prod.product_name || prod.name}\\n`;\n  message += `   ðŸ“¦ Ð”Ð½ÐµÐ¹ Ð½ÐµÑ‚: ${prod.days_out_of_stock}\\n`;\n  message += `   â­ ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚: ${prod.priority_score}\\n`;\n  message += `   â¤ï¸ Ð˜Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ: ${prod.favorites_count?.toLocaleString() || 0}\\n\\n`;\n});\n\nif (critical.length > 10) {\n  message += `... Ð¸ ÐµÑ‰Ðµ ${critical.length - 10} Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²`;\n}\n\nreturn { json: { message, count: critical.length } };"
          },
          "id": "format-message",
          "name": "Format Message",
          "type": "n8n-nodes-base.code",
          "typeVersion": 2,
          "position": [850, 200]
        },
        {
          "parameters": {
            "chatId": "={{ $env.TELEGRAM_CHAT_ID }}",
            "text": "={{ $json.message }}",
            "additionalFields": {}
          },
          "id": "send-notification",
          "name": "Send Notification",
          "type": "n8n-nodes-base.telegram",
          "typeVersion": 1,
          "position": [1050, 200]
        }
      ],
      "connections": {
        "Schedule Trigger": {
          "main": [[{ "node": "Get Critical Products", "type": "main", "index": 0 }]]
        },
        "Get Critical Products": {
          "main": [[{ "node": "Has Critical?", "type": "main", "index": 0 }]]
        },
        "Has Critical?": {
          "main": [
            [{ "node": "Format Message", "type": "main", "index": 0 }],
            []
          ]
        },
        "Format Message": {
          "main": [[{ "node": "Send Notification", "type": "main", "index": 0 }]]
        }
      }
    }
  ]
}

