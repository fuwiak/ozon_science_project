{
  "name": "Telegram API - Ultra Simple",
  "nodes": [
    {
      "parameters": {
        "updates": ["message", "callback_query"],
        "additionalFields": {}
      },
      "id": "telegram-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// JEDEN wƒôze≈Ç: rozpoznaje komendƒô, wywo≈Çuje API, formatuje odpowied≈∫\nconst text = ($input.item.json.message?.text || '').trim();\nconst chatId = $input.item.json.message?.chat?.id;\nconst baseUrl = 'https://ozonscienceproject-production.up.railway.app';\n\n// Mapowanie komend\nconst commands = {\n  '/stats': { url: '/api/cache/stats', type: 'stats' },\n  '/cache': { url: '/api/cache/stats', type: 'stats' },\n  '/dashboard': { url: '/api/analytics/pricing-metrics?min_days_out_of_stock=15', type: 'dashboard' },\n  '/metrics': { url: '/api/analytics/pricing-metrics?min_days_out_of_stock=15', type: 'dashboard' },\n  '/products': { url: '/api/products?page=1&page_size=5', type: 'products' },\n  '/top': { url: '/api/analytics/demand/top?limit=10', type: 'top' },\n  '/outofstock': { url: '/api/analytics/stock/out-of-stock?min_days=30', type: 'outofstock' },\n  '/cache_clear': { url: '/api/cache/clear', type: 'cache_action', method: 'POST' },\n  '/cache_reload': { url: '/api/cache/reload', type: 'cache_action', method: 'POST' },\n  '/help': { url: null, type: 'help' }\n};\n\n// Sprawd≈∫ komendƒô\nif (!text.startsWith('/')) {\n  return [{ json: { chatId, message: '‚ùå –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É, –Ω–∞—á–∏–Ω–∞—é—â—É—é—Å—è —Å /' } }];\n}\n\nconst command = text.split(' ')[0].toLowerCase();\nconst cmdData = commands[command];\n\nif (!cmdData) {\n  return [{ json: { chatId, message: '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help' } }];\n}\n\n// Help\nif (cmdData.type === 'help') {\n  return [{ json: { \n    chatId, \n    message: `ü§ñ <b>Dynamic Pricing 1299$</b>\\n\\n` +\n      `üìä /dashboard - –ú–µ—Ç—Ä–∏–∫–∏\\n` +\n      `üì¶ /products - –¢–æ–≤–∞—Ä—ã\\n` +\n      `üèÜ /top - –¢–æ–ø —Ç–æ–≤–∞—Ä–æ–≤\\n` +\n      `‚ö†Ô∏è /outofstock - –ë–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞\\n` +\n      `üìà /metrics - –ú–µ—Ç—Ä–∏–∫–∏\\n` +\n      `üóÑÔ∏è /cache - –ö—ç—à\\n` +\n      `üóëÔ∏è /cache_clear - –û—á–∏—Å—Ç–∏—Ç—å\\n` +\n      `üîÑ /cache_reload - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å\\n` +\n      `‚ùì /help - –ü–æ–º–æ—â—å`\n  } }];\n}\n\n// Wywo≈Çaj API - u≈ºyj $http je≈õli dostƒôpny, w przeciwnym razie fetch\nlet apiResponse;\ntry {\n  const method = cmdData.method || 'GET';\n  const url = baseUrl + cmdData.url;\n  \n  // Spr√≥buj u≈ºyƒá $http (n8n built-in)\n  if (typeof $http !== 'undefined') {\n    apiResponse = await $http.request({\n      method: method,\n      url: url,\n      headers: { 'Content-Type': 'application/json' }\n    });\n  } else if (typeof fetch !== 'undefined') {\n    // Fallback do fetch\n    const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' } });\n    apiResponse = await response.json();\n  } else {\n    // Je≈õli nic nie dzia≈Ça, zwr√≥ƒá b≈ÇƒÖd\n    throw new Error('Brak dostƒôpu do HTTP w Code node. U≈ºyj HTTP Request node.');\n  }\n} catch (error) {\n  return [{ json: { chatId, message: `‚ùå –û—à–∏–±–∫–∞: ${error.message}` } }];\n}\n\n// Formatuj odpowied≈∫\nlet message = '';\n\nswitch(cmdData.type) {\n  case 'stats':\n    message = `üìä <b>–ö—ç—à</b>\\n` +\n      `–¢–æ–≤–∞—Ä–æ–≤: ${apiResponse.total_products?.toLocaleString() || 0}\\n` +\n      `–§–∞–π–ª–æ–≤: ${apiResponse.files_loaded || 0}\\n` +\n      `–†–∞–∑–º–µ—Ä: ${apiResponse.cache_size_mb?.toFixed(2) || 0} –ú–ë`;\n    break;\n    \n  case 'dashboard':\n    const metrics = apiResponse.metrics || [];\n    const highPriority = metrics.filter(m => m.priority_score >= 70).length;\n    const criticalStock = metrics.filter(m => m.days_out_of_stock > 30).length;\n    const highDemand = metrics.filter(m => m.demand_level === 'high').length;\n    message = `üìä <b>–î–∞—à–±–æ—Ä–¥</b>\\n` +\n      `üî¥ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: ${highPriority}\\n` +\n      `üì¶ –ö—Ä–∏—Ç–∏—á–Ω—ã–µ: ${criticalStock}\\n` +\n      `üìà –°–ø—Ä–æ—Å: ${highDemand}\\n` +\n      `–í—Å–µ–≥–æ: ${metrics.length}`;\n    break;\n    \n  case 'products':\n    const products = apiResponse.products || [];\n    message = `üì¶ <b>–¢–æ–≤–∞—Ä—ã</b> (${apiResponse.total || 0})\\n\\n`;\n    products.slice(0, 5).forEach((p, i) => {\n      message += `${i + 1}. ${p.name || p.product_name}\\n` +\n        `   ‚ù§Ô∏è ${p.favorites_count?.toLocaleString() || 0}\\n`;\n    });\n    break;\n    \n  case 'top':\n    const topProducts = Array.isArray(apiResponse) ? apiResponse : [];\n    message = `üèÜ <b>–¢–æ–ø</b>\\n\\n`;\n    topProducts.slice(0, 5).forEach((p, i) => {\n      message += `${i + 1}. ${p.product_name || p.name}\\n` +\n        `   ‚ù§Ô∏è ${p.favorites_count?.toLocaleString() || 0}\\n`;\n    });\n    break;\n    \n  case 'outofstock':\n    const outOfStock = Array.isArray(apiResponse) ? apiResponse : [];\n    message = `‚ö†Ô∏è <b>–ë–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞</b> (${outOfStock.length})\\n\\n`;\n    outOfStock.slice(0, 5).forEach((p, i) => {\n      message += `${i + 1}. ${p.product_name || p.name}\\n` +\n        `   üì¶ ${p.days_out_of_stock || 0} –¥–Ω–µ–π\\n`;\n    });\n    break;\n    \n  case 'cache_action':\n    message = apiResponse.message || `‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ: ${command}`;\n    break;\n    \n  default:\n    message = JSON.stringify(apiResponse, null, 2).substring(0, 1000);\n}\n\nreturn [{ json: { chatId, message } }];"
      },
      "id": "handle-all",
      "name": "Handle All",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "chatId": "={{ $json.chatId }}",
        "text": "={{ $json.message }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "id": "send-telegram",
      "name": "Send Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [650, 300]
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Handle All",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle All": {
      "main": [
        [
          {
            "node": "Send Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}

